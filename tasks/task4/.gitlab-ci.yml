stages:
  - build
  - test
  - deploy
  - tag

variables:
  IMAGE_TAG: latest
  IMAGE_NAME: booking-service

build:
  stage: build
  script:
    - cd booking-service
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
    - docker images | grep ${IMAGE_NAME}

test:
  stage: test
  script:
    - docker run -d --name test-container -p 8080:8080 ${IMAGE_NAME}:${IMAGE_TAG}
    - sleep 5
    - curl -f http://localhost:8080/ping || exit 1
    - curl -f http://localhost:8080/health || exit 1
    - curl -f http://localhost:8080/ready || exit 1
    - docker rm -f test-container

deploy:
  stage: deploy
  script:
    - minikube image load ${IMAGE_NAME}:${IMAGE_TAG}
    - helm upgrade --install booking-service ./helm/booking-service --values ./helm/booking-service/values.yaml
    - kubectl rollout status deployment/booking-service
    - kubectl get pods -l app=booking-service
    - kubectl get svc booking-service

tag:
  stage: tag
  script:
    - TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    - git tag "deploy-${TIMESTAMP}"
    - echo "Created tag deploy-${TIMESTAMP}"
  only:
    - main
